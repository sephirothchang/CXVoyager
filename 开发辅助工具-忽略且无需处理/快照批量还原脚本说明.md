# vSphere 快照批量还原脚本

> **许可证**：本文档依据 [GNU GPLv3](../LICENSE) 授权发布。

本目录包含一个用于 **批量将指定 vSphere 虚拟机还原到某个快照并可选开机** 的脚本：`restore_vm_snapshot.py`。

## 功能
- 连接 vCenter (pyVmomi)
- 支持多个虚拟机名称
- 查找并还原指定快照（递归遍历）
- 可选自动开机并等待 poweredOn
- 对每台虚拟机分别汇总结果，不因单台失败中断
- CLI 参数与环境变量结合，便于集成 CI / 自动化

## 依赖安装
```powershell
pip install -r requirements.txt
```

## 使用示例
```powershell
# 建议先通过环境变量提供密码（避免明文出现在命令历史）
$env:VCENTER_PASSWORD="P@ssw0rd!123"

python .\restore_vm_snapshot.py `
  --server vcsa.c89.fun `
  --user administrator@vsphere.local `
  --vm SMTX-AUTO-DEPLOY-HOST-0001 SMTX-AUTO-DEPLOY-HOST-0002 SMTX-AUTO-DEPLOY-HOST-0003 `
  --snapshot-name OS-Installed `
  --power-on --wait-poweron --insecure
```

## 参数说明
| 参数 | 说明 |
|------|------|
| --server | vCenter FQDN/IP |
| --user | 登录用户名 |
| --password | 登录密码（可留空改用交互式或环境变量） |
| --vm | 一个或多个虚拟机名称 |
| --snapshot-name | 目标快照名称 |
| --insecure | 忽略 TLS 证书校验（实验/自签发环境常用） |
| --power-on | 还原后执行开机 |
| --wait-poweron | 开机后等待状态变为 poweredOn |
| --poweron-timeout | 等待开机的最长秒数（默认 300） |
| --quiet | 仅输出最终汇总 |

## 返回码约定
- 0: 所有虚拟机处理成功
- 1: 至少一台失败
- 2: 无法连接 vCenter

## 安全建议
- 切勿把生产密码硬编码到脚本中。
- 优先使用环境变量：`VCENTER_PASSWORD`；CI/CD 中可用密文注入。
- 若必须使用 --password，注意清理 shell 历史。

## 常见问题
1. ImportError: No module named pyVim / pyVmomi  -> 运行 `pip install pyvmomi`
2. 证书错误 -> 添加 `--insecure` 或在企业环境导入受信任证书
3. 找不到快照 -> 确认快照名称大小写一致；脚本使用精确匹配

## 许可证
可自由修改与分发（内部使用）。
