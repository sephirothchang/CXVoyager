# 关于自动化部署工具的一些想法

> **许可证**：本文档依据 [GNU GPLv3](../LICENSE) 授权发布。

## 自动配置BIOS

    暂无想法
    
## 自动安装操作系统

    如果可以使用，带外是工程师自己的、独立vlan无其他设备、或带外交换机暂时不上联（排除PXE的二层播发意外扩散）
    使用PXE进行网络引导，配合魔改的自动部署kickstart文件实现无人值守安装。
    或许可以通过redfish，但是这个需要适配每个厂商

    或者使用cluster installer

## 自动配置ip

    如果可以使用私网交换机，限制广播域，可以通过在AIO虚拟机内起一个DHCP播发ip，使管理口自动获取IP
    
    当前部署逻辑需要至少一个管理口有ip

    之后可以通过DHCP或者静态IP的方式进行自动配置，具体方案需要根据实际情况进行选择。

## 确定主机顺序

    人工？主机名？mac地址？



## 如何确定网口用途

提供手动覆盖变量，如果手动没有配置为空或者非法，则自动二次检测。

### 管理口
    如果是AB，有一个口已经配了IP，A是确定的；B的确定需要进行ping操作，因为初始化完成之前，集群VIP是空闲状态，
    可以给每个口临时分配VIP的地址，然后互ping，通的就是B口，不通就下一个循环。（有vlan就创建vlan子接口）

        伪代码

        for dev in <network_interfaces>
            do
                while true
                    do
                        ip addr add <vip> dev <dev>
                        if other hosts ping <vip> success
                    # 当前端口成为 mgmt-backup
                    mark as mgmt-backup
                else
                    ip addr del <vip> dev <dev>
                    ip addr add <vip> dev <dev>
                    if other hosts ping <vip> success
                        # 当前端口成为 mgmt-backup
                        mark as mgmt-backup
                    else
                        ip addr del <vip> dev <dev>
                        # 等待一段时间后重试
                        sleep <interval>
                    end if
                end if
                # 等待一段时间后再次检测
                sleep <interval>
            end do
        end while

    如果是LACP，在部署开始前会手动配置pre_bond，所以无需检测，直接使用pre_bond的slave端口即可

### 存储口
    确定管理口之后，剩下的UP端口就是存储口。（业务口在部署之前人工先拔了）

    for dev in <network_interfaces>
        do
            if ethtool <dev> 速率大于1000且up
            then
                # 当前端口成为 storage
                mark as storage
            end if
        end do

    如果没有up、小于2或大于2，则选择速率大于等于10000的口，如果有多个，默认选择前缀不一样的（例如ens4np0，ens4np1，ens5np1三个口，用ens5np1和ens4np1满足拓扑冗余）
        AB
        然后配个地址互ping一下，通的就是存储口（存储一般Access端口）
        LACP
        建个lacp bond，配个地址互ping一下，通的就是存储口

### 业务口
    业务口在部署之前人工先临时拔了，所以在自动检测的时候，剩下的两个口就是业务口；如果遇到大于2的情况，前缀一样的优先排除
    （例如ens4np0，ens4np1，ens5np1三个口，用ens5np1和ens4np1满足拓扑冗余）


## 如何自动检测硬盘用途

### 先确定是分层还是不分层，这个可以人工指定 ###

### 软R1

    分层
        启动盘挂载在/boot
    
        系统盘（含元数据分区的缓存盘）看mdadm，成员即为含元数据分区的缓存盘

        缓存盘
            如果还有ssd，直接标记为cache（混闪有ssd必定是缓存）
            
        数据盘
            如果是hdd，直接标记为data（混闪的hdd必定是数据盘）

    不分层
        全闪不用判断，除了系统盘是含元数据分区的数据盘，其他全是数据盘


### 硬R1

    系统盘无需检测，查看挂载点即可确定排除

    分层（包含混闪和全闪分层）
        缓存盘
            如果是nvme直接标记为cache（混闪和全闪分层有nvme必定是缓存）

            如果都是sata，那看rotational属性，有的话是ssd，没的话是hdd
                如果全是sata ssd，那容量小的是缓存，容量大的就是数据盘
                如果hdd和ssd混合，那ssd必定是缓存，hdd是数据盘

        数据盘
            如果是hdd直接标记为data（混闪分层的hdd必定是数据盘）

    不分层
        全闪不用判断，全是数据盘




## 自动检查NTP可用性
    先 nc 测一下123端口能不能通

## 自动检查DNS可用性
    先nslookup一下dns能不能通

## 基于 Excel 的自动化部署流程

新增脚本：

- `create_example_excel.py` 生成示例配置表 `deployment_config.xlsx`
- `deploy_from_excel.py` 读取表格 + 调用主机扫描 API + 构建部署载荷 + 调用部署接口

### 1. 生成示例表格
```bash
python create_example_excel.py
```
生成后会出现 `deployment_config.xlsx`，包含：

Sheet Cluster:
    - platform, cluster_name, dns_server, ntp_mode, ntp_server, gateway
    - vds_mgt_name, vds_sds_name, bond_mode_mgt, bond_mode_sds
    - vhost_enabled, rdma_enabled

Sheet Hosts:
    - host_ip: 主机管理面访问 IP（用于扫描接口）
    - host_ipv6_iface: 用于取 IPv6 link-local 的网卡名
    - mgt_ip / storage_ip: 部署载荷里的管理/存储 IP
    - hostname / host_uuid
    - root_password / smartx_password
    - is_master / with_faster_ssd_as_cache / disk_data_with_cache
    - override_nics_mgt / override_nics_sds: 逗号分隔自定义 NIC 列表

为空表示由扫描接口结果或默认值推导。

### 2. 扫描主机
`deploy_from_excel.py` 默认会对 Hosts 表中每台 host_ip 调用：
```
GET http://<host_ip>/api/v2/deployment/host
Headers: host: <host_ip>, x-smartx-token: <token>
```
扫描结果中预期包含 nics(disks...)；脚本会：
    - 选出指定 iface (host_ipv6_iface) 的 fe80:: 链路本地地址，生成 host_ip 字段形如：`fe80::abcd%ens192`
    - 提取磁盘列表填入 payload（分类逻辑可后续增强）

### 3. 构建部署载荷
载荷字段与之前 curl 示例一致：
    - vdses 根据 override_nics_* 生成；为空则使用默认 `[ens224,ens192]` / `[ens256,ens161]`
    - networks 中 route 使用 Cluster.gateway（若存在）
    - hosts[].host_ip 来自扫描 IPv6 + 接口名

### 4. 执行部署
```bash
export SMARTX_TOKEN=<token>
python deploy_from_excel.py --excel deployment_config.xlsx --output payload.json --dry-run
# 检查 payload.json 正确后执行真实部署
python deploy_from_excel.py --excel deployment_config.xlsx
```
可选参数：
    --skip-scan   跳过扫描（使用表格与占位 IPv6）
    --primary-host 指定部署请求发送的主机（默认第一台 host 的 host_ip）
    --dry-run      仅输出载荷不发送
    --output       保存载荷 JSON

### 5. 后续可扩展
- 从扫描结果自动识别磁盘角色（系统盘/缓存/数据）
- 支持多 NTP 模式切换 (external 时附加 ntp_server)
- 增加日志与失败重试
- 对部署返回进行状态轮询

### 6. 注意事项
- Excel 中 true/false 需小写或统一由脚本转换；空值表示不覆盖。
- host_ipv6_iface 必须在扫描结果中存在且带有 fe80::，否则 host_ip 为空字符串（部署可能失败）。
- token 可通过环境变量 `SMARTX_TOKEN` 传入，避免写死。








## 自动化部署集群的示例API调用

扫描集群
请求网址
http://10.0.20.204/api/v2/deployment/cluster
请求方法
GET
远程地址
10.0.20.204:80

accept
*/*
accept-encoding
gzip, deflate
accept-language
zh-CN,zh;q=0.9
cache-control
no-cache
connection
keep-alive
content-type
application/json
host
10.0.20.204
if-modified-since
Mon, 26 Jul 1997 05:00:00 GMT
pragma
no-cache
referer
http://10.0.20.204/install.html
user-agent
Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36
x-requested-with
XMLHttpRequest
x-smartx-token
e79b85fc18b7402fbcc0391fe8d7d24c



curl --location 'http://192.168.25.250/api/v2/deployment/cluster' \
--header 'X-Smartx-Token: e79b85fc18b7402fbcc0391fe8d7d24c' \
--header 'Content-Type: application/json' \
--data '{
    "platform": "kvm",
    "cluster_name": "host-password",
    "dns_server": [
        "114.114.114.114"
    ],
    "vdses": [
        {
            "name": "mgmt-network",
            "hosts_associated": [
                {
                    "host_uuid": "df632230-ed73-11ee-a57b-525400027dbc",
                    "nics_associated": [
        },
        {
            "name": "storage-network",
            "hosts_associated": [
                {
                    "host_uuid": "df632230-ed73-11ee-a57b-525400027dbc",
                    "nics_associated": [
                        "eth1"
                    ]
                }
            ]
        }
    ],
    "networks": [
        {
            "name": "mgt-network",
            "attached_vds": "mgmt-network",
            "network_type": "mgt",
            "network_config": {
                "service": [
                    {
                        "host_uuid": "df632230-ed73-11ee-a57b-525400027dbc",
                        "service_interface_name": "port-mgt",
                        "service_interface_ip": "192.168.25.250",
                        "netmask": "255.255.240.0"
                    }
                ],
                "route": [
                    {
                        "gateway": "192.168.16.1"
                    }
                ]
            },
            "mode": {
                "type": "vlan_access",
                "network_identities": [
                    0
                ]
            }
        },
        {
            "name": "storage-network",
            "attached_vds": "storage-network",
            "network_type": "storage",
            "network_config": {
                "service": [
                    {
                        "host_uuid": "df632230-ed73-11ee-a57b-525400027dbc",
                        "service_interface_name": "port-storage",
                        "service_interface_ip": "10.168.25.250",
                        "netmask": "255.255.255.0"
                    }
                ]
            },
            "mode": {
                "type": "vlan_access",
                "network_identities": [
                    0
                ]
            }
        }
    ],
    "hosts": [
        {
            "host_ip": "fe80::5054:ff:fe8f:d47d%eth1",
            "host_uuid": "df632230-ed73-11ee-a57b-525400027dbc",
            "hostname": "node-1",
            "disk_data_with_cache": true,
            "host_passwords": [
                {
                    "user": "root",
                    "password": ""
                },
                {
                    "user": "smartx",
                    "password": "EpD4aLRZ"
                }
            ],
            "tags": [],
            "ifaces": [
                {
                    "ip": "192.168.25.250",
                    "function": "mgt"
                },
                {
                    "ip": "10.168.25.250",
                    "function": "storage"
                }
            ],
            "disks": [
                {
                    "drive": "sdb",
                    "function": "smtx_system",
                    "model": "SMARTX_ZBS",
                    "serial": "6a3c2a29-9153-4bd8-bfce-afd877cc2857",
                    "size": 268435456000,
                    "type": "SSD"
                },
                {
                    "drive": "sdc",
                    "function": "data",
                    "model": "SMARTX_ZBS",
                    "serial": "3611ecee-75a4-42e2-90e9-6b5f5bb500f5",
                    "size": 214748364800,
                    "type": "SSD"
                },
                {
                    "drive": "sdd",
                    "function": "smtx_system",
                    "model": "SMARTX_ZBS",
                    "serial": "80ae6ec7-9ef2-4c91-9eba-13789010b37a",
                    "size": 268435456000,
                    "type": "SSD"
                }
            ],
            "is_master": true,
            "with_faster_ssd_as_cache": true
        }
    ],
    "ntp": {
        "mode": "external",
        "ntp_server": [
            "192.168.64.1"
        ]
    },
    "vhost_enabled": false,
    "rdma_enabled": false
}'
