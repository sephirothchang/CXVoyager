# STEP 15 - CLEANUP

目的
- 在部署或测试结束后回收临时资源、清理敏感凭据、移除上传的临时镜像和归档部署产物。

输入
- 上游阶段输出（artifact 路径、上传摘要、session token 等）

输出
- `ctx.extra['cleanup']`：清理结果与失败/跳过项

关键模块
- `cxvoyager.core.deployment.handlers.cleanup`：实现清理策略（软删除/彻底移除、证书/token 清理等）。

主要流程
1. 根据配置与上下文决定需要清理的资源（上传卷、临时虚机、会话 token、临时文件）。
2. 优先执行非破坏性清理（删除本地 artifact、撤销临时配置），并在确认后执行彻底移除（镜像、卷）。
3. 清理完毕后归档部署日志与报告（移至 `artifacts/` 或压缩存档），并将 summary 写入 `ctx.extra['cleanup']`。

容错与注意事项
- 清理操作具有破坏性，默认应使用 `dry-run` 或 `confirm` 选项要求人工确认。
- 对于失败的清理项需保留详细日志并提供手动清理指引。

日志与可观测
- 记录每项清理动作的状态、所影响的资源与时间戳，便于后续审计。